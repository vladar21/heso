{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

<!-- FullCalendar -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        editable: true,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: JSON.parse('{{ lessons_list|safe }}'),
        eventContent: function(arg) {
            var class_topic = arg.event.extendedProps.class_topic;
            
            var location = arg.event.extendedProps.location;
            if (location == 'online'){
                var meeting_link = `<div><i class="fas fa-video"></i> Meeting link: <b><a href="${arg.event.extendedProps.meeting_link}" target="_blank" style="color: lightblue;">Join</a></b></div>`
            }else{
                var meeting_link = `<div><i class="fas fa-video"></i> Location: <b>Onsite<b></div>`
            }

            // Example HTML structure with FontAwesome icons
            return {
                html: `
                    <div style="padding: 4px; background-color: ${arg.event.backgroundColor}; color: white; border-radius: 4px;">
                        <b>${arg.event.title}</b><br>
                        <div><i class="fas fa-book"></i> Topic: ${class_topic}</div>
                        ${meeting_link}
                    </div>
                `
            };
        },
        eventDrop: function(info) {
            var lesson = info.event;
            var lessonId = lesson.id;
           
            var startTime = lesson.start.toISOString();
            var endTime = lesson.end.toISOString();
            var csrftoken = getCookie('csrftoken'); // Retrieve CSRF token

            // Prepare data payload including CSRF token
            var data = JSON.stringify({
                id: lessonId,
                start: startTime,
                end: endTime,
            });

            fetch('{% url "update_lesson" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken, // Include CSRF token in request headers
                },
                body: data,
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status == 'error') {
                    // Revert the event back to its original position
                    info.revert();
                    console.error('Error:', data.message);
                } else {
                    console.log('Success:', data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                // Revert the event back to its original position
                info.revert();
            });
        },
        eventClick: function(info) {
            var lessonId = info.event.id;
            $('#lessonId').val(lessonId);
            $('#editLessonModalLabel').text('Edit Lesson: ' + info.event.title); // Example to set modal title dynamically
            $('#lessonTitle').val(info.event.title);
            $('#lessonDescription').val(info.event.extendedProps.description)
            // Format start and end times to 'YYYY-MM-DDTHH:MM' for datetime-local input
            var startTime = new Date(info.event.start).toISOString().slice(0, 16);
            var endTime = new Date(info.event.end).toISOString().slice(0, 16);
            $('#lessonStartTime').val(startTime);
            $('#lessonEndTime').val(endTime);
            // Populate other fields
            $('#googleMeetLink').val(info.event.extendedProps.meeting_link)
            // Filling in the location
            $('#lessonLocation').val(info.event.extendedProps.location);
            // Filling in the teachers
            var teacherSelect = $('#lessonTeacher');
            teacherSelect.empty(); // Clearing previous options
            info.event.extendedProps.teachers.forEach(function(teacher) {
                teacherSelect.append(new Option(teacher.username, teacher.id));
            });

            // Filling in the students
            var studentSelect = $('#lessonStudents');
            studentSelect.empty(); // Clearing previous options
            info.event.extendedProps.students.forEach(function(student) {
                studentSelect.append(new Option(student.username, student.id));
            });

            // Filling in materials
            var materialSelect = $('#lessonMaterials');
            materialSelect.empty(); // Clearing previous options
            info.event.extendedProps.materials.forEach(function(material) {
                materialSelect.append(new Option(material.title, material.id));
            });

            $('#editLessonModal').modal('show'); // Open the modal
        },

    });
    calendar.render();
});

</script>
{% endblock extra_head %}


{% block content %}
<div id='calendar'></div>

<!-- Edit Lesson Modal -->
<div class="modal fade" id="editLessonModal" tabindex="-1" aria-labelledby="editLessonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editLessonModalLabel">Edit Lesson Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="editLessonForm">
            <input type="hidden" id="lessonId" name="lessonId" value="">
            <div class="form-group">
              <label for="lessonTitle">Title</label>
              <input type="text" class="form-control" id="lessonTitle" name="title" disabled>
            </div>
            <div class="form-group">
              <label for="lessonDescription">Description</label>
              <textarea class="form-control" id="lessonDescription" name="description"></textarea>
            </div>
            <div class="form-group">
              <label for="lessonStartTime">Start Time</label>
              <input type="datetime-local" class="form-control" id="lessonStartTime" name="start_time">
            </div>
            <div class="form-group">
              <label for="lessonEndTime">End Time</label>
              <input type="datetime-local" class="form-control" id="lessonEndTime" name="end_time">
            </div>
            <div class="form-group">
              <label for="lessonLocation">Location</label>
              <select class="form-control" id="lessonLocation" name="location">
                <option value="on-site">On-site</option>
                <option value="online">Online</option>
              </select>
            </div>
            <div class="form-group">
              <label for="googleMeetLink">Meeting Link</label>
              <input type="url" class="form-control" id="googleMeetLink" name="google_meet_link">
            </div>
            <!-- Additional fields for teacher, students, and materials -->
            <div class="form-group">
              <label for="lessonTeacher">Teacher</label>
              <select class="form-control" id="lessonTeacher" name="teacher">
                <!-- Dynamically populate teachers -->
              </select>
            </div>
            <div class="form-group">
              <label for="lessonStudents">Students</label>
              <select multiple class="form-control" id="lessonStudents" name="students">
                <!-- Dynamically populate students -->
              </select>
            </div>
            <div class="form-group">
              <label for="lessonMaterials">Materials</label>
              <select multiple class="form-control" id="lessonMaterials" name="materials">
                <!-- Dynamically populate materials -->
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="saveLessonDetails()">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  
{% endblock content %}

{% block extra_js %}
<script>
  
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  function saveLessonDetails() {
    var lessonId = $('#lessonId').val();
    var formData = new FormData(document.getElementById('editLessonForm'));
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken')); // CSRF token

    fetch('{% url "update_lesson" %}', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin' // is necessary for correct operation of CSRF
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Lesson updated successfully');
            $('#editLessonModal').modal('hide');
            var event = calendar.getEventById(lessonId);
            if(event) {
              // Getting data from the form
              var title = document.getElementById('lessonTitle').value;
              var description = document.getElementById('lessonDescription').value;
              var startTime = document.getElementById('lessonStartTime').value;
              var endTime = document.getElementById('lessonEndTime').value;
              var location = document.getElementById('lessonLocation').value;
              var meetingLink = document.getElementById('googleMeetLink').value;
              var teacher = $('#lessonTeacher option:selected').text();
              
              // Updating the event properties
              event.setProp('title', title);
              event.setStart(startTime);
              event.setEnd(endTime);
              event.setExtendedProp('description', description);
              event.setExtendedProp('location', location);
              event.setExtendedProp('meeting_link', meetingLink);
              event.setExtendedProp('teacher', teacher);

              // Update the calendar to show changes
              // calendar.refetchEvents();
            }
        } else {
            alert('Error updating lesson: ' + data.message);
        }
    })
    .catch(error => console.error('Error:', error));
  }

  // var teachersList = JSON.parse('{{ teachers|safe }}');
  // $('#editLessonModal').on('show.bs.modal', function () {
  //   var teacherSelect = $('#lessonTeacher');
  //   teacherSelect.empty();
  //   teachersList.forEach(function(teacher) {
  //       teacherSelect.append(new Option(teacher.name, teacher.id));
  //   });
  // });

</script>
{% endblock extra_js %}
